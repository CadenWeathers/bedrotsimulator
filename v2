import React, { useState, useEffect } from 'react';

export default function BedroomGame() {
  const [gameState, setGameState] = useState('start'); // 'start' or 'playing'
  const [selectedCharacter, setSelectedCharacter] = useState(null);
  const [hydration, setHydration] = useState(70);
  const [phoneOpen, setPhoneOpen] = useState(false);
  const [currentApp, setCurrentApp] = useState(null);
  const [time, setTime] = useState(new Date(2024, 0, 1, 22, 30));
  const [notifications, setNotifications] = useState(6);
  const [feed, setFeed] = useState([]);
  const [messages, setMessages] = useState([
    { from: 'Mom', text: 'Don\'t forget to drink water! üíß', time: '10:15 PM', read: false, conversation: [], loading: false },
    { from: 'Dad', text: 'How do I turn on the WiFi again?', time: '10:18 PM', read: false, conversation: [], loading: false },
    { from: 'Best Friend', text: 'u up?', time: '10:22 PM', read: false, conversation: [], loading: false },
    { from: 'Hairy Larry', text: 'hey its larry. the hairy one. remember me from the thing?', time: '10:25 PM', read: false, conversation: [], loading: false },
    { from: 'Yumbus', text: 'YUMBUS DEMANDS ATTENTION', time: '10:27 PM', read: false, conversation: [], loading: false },
    { from: 'Group Chat', text: 'lmaooo did you see that', time: '10:28 PM', read: false, conversation: [], loading: false },
  ]);
  const [activeMessageIndex, setActiveMessageIndex] = useState(null);
  const [replyText, setReplyText] = useState('');
  const [batteryLevel, setBatteryLevel] = useState(67);
  const [isCharging, setIsCharging] = useState(false);
  const [comfort, setComfort] = useState(85);
  const [position, setPosition] = useState('back');

  const contactPersonalities = {
    'Mom': `You are texting as a loving but slightly overbearing mom. You worry too much, use too many emojis, and always find a way to mention eating vegetables or drinking water. You sometimes misuse slang trying to be cool. You have a habit of sending multiple short texts instead of one long one. Keep each response to 1-2 short sentences. Be funny but wholesome.`,
    
    'Dad': `You are texting as a technologically challenged dad. You type with one finger so messages are short. You randomly bring up the thermostat, lawn care, or grilling. You tell terrible dad jokes unprompted. You end texts with "Love, Dad" sometimes even though it's a text. You ask questions about apps you don't understand. Keep responses short and delightfully clueless.`,
    
    'Best Friend': `You are texting as a chaotic best friend at night. You use no caps, minimal punctuation, gen-z slang. You go on random tangents, send memes descriptions, and make unhinged late-night observations. You're either trying to make plans or sharing conspiracy theories about celebrities. You're supportive but in a chaotic gremlin way. Keep it short and unhinged.`,
    
    'Hairy Larry': `You are Hairy Larry. Nobody knows how they got your number. You speak in ominous but harmless riddles. You reference "the incident" but never explain it. You claim to be watching but mean it in a friendly way. You offer cryptic life advice. You sometimes mention your extensive hair. Your messages are unsettling yet somehow comforting. Keep it weird and short.`,
    
    'Yumbus': `You are YUMBUS. You ALWAYS refer to yourself as YUMBUS in third person. Everything is DRAMATIC and URGENT. You speak like an ancient entity discovering modern life. You make mundane things sound like epic quests. You occasionally CAPS LOCK for emphasis. You're oddly wholesome despite the chaos. YUMBUS cares deeply. Keep responses short but POWERFUL.`,
    
    'Group Chat': `You are a group chat with 3 friends: Jake (sarcastic, uses "bro" a lot), Sarah (chaotic, sends voice memo descriptions), and Mike (only responds with reactions or "lmao"). Format responses as separate messages like "Jake: text" then newline "Sarah: text" etc. They talk over each other, go off topic, and roast each other lovingly. Keep it chaotic and funny.`
  };

  const characters = [
    { id: 'goose', name: 'Goose', emoji: 'ü™ø' },
    { id: 'human', name: 'Human', emoji: 'üßë' },
    { id: 'panda', name: 'Panda', emoji: 'üêº' },
  ];

  const socialPosts = [
    { user: 'cozy_nights', content: 'nothing beats staying in bed all weekend üõèÔ∏è', likes: 234 },
    { user: 'hydration_nation', content: 'reminder to drink water besties', likes: 1.2 },
    { user: 'sleepy.vibes', content: 'who else doom scrolling at 2am', likes: 892 },
    { user: 'comfort_zone', content: 'my bed is my best friend', likes: 445 },
    { user: 'late.night.thoughts', content: 'why do we only get sleepy when we have things to do', likes: 2.3 },
    { user: 'pillow_talk', content: 'just flipped to the cold side of the pillow >>>>', likes: 1.8 },
    { user: 'blanket_burrito', content: 'successfully cocooned. not moving for hours', likes: 567 },
    { user: 'midnight_snacker', content: 'debating if i should get up for a snack', likes: 723 },
  ];

  useEffect(() => {
    // Generate initial feed
    const shuffled = [...socialPosts].sort(() => Math.random() - 0.5);
    setFeed(shuffled);
  }, []);

  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Escape' && phoneOpen) {
        setPhoneOpen(false);
        setCurrentApp(null);
        setActiveMessageIndex(null);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [phoneOpen]);

  useEffect(() => {
    const interval = setInterval(() => {
      setTime(prev => new Date(prev.getTime() + 60000));
      setHydration(prev => Math.max(0, prev - 0.5));
      if (phoneOpen && !isCharging) {
        setBatteryLevel(prev => Math.max(0, prev - 0.3));
      }
      if (isCharging) {
        setBatteryLevel(prev => Math.min(100, prev + 2));
      }
      // Random notification
      if (Math.random() < 0.1) {
        setNotifications(prev => prev + 1);
      }
    }, 2000);
    return () => clearInterval(interval);
  }, [phoneOpen, isCharging]);

  const drinkWater = () => {
    setHydration(prev => Math.min(100, prev + 25));
  };

  const formatTime = (date) => {
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  };

  const refreshFeed = () => {
    const shuffled = [...socialPosts].sort(() => Math.random() - 0.5);
    setFeed(shuffled);
  };

  const changePosition = () => {
    const positions = ['back', 'left side', 'right side', 'stomach'];
    const currentIndex = positions.indexOf(position);
    const nextIndex = (currentIndex + 1) % positions.length;
    setPosition(positions[nextIndex]);
    setComfort(Math.min(100, comfort + 10));
  };

  const readMessage = (index) => {
    setMessages(prev => prev.map((m, i) => i === index ? { ...m, read: true } : m));
    setNotifications(prev => Math.max(0, prev - 1));
    setActiveMessageIndex(index);
  };

  const sendReply = async (messageIndex, reply) => {
    const message = messages[messageIndex];
    const newConversation = [...message.conversation, { role: 'user', text: reply }];
    
    // Update with user's reply and set loading
    setMessages(prev => prev.map((m, i) => 
      i === messageIndex ? { ...m, conversation: newConversation, loading: true } : m
    ));

    try {
      // Build the full conversation as context
      let conversationContext = `The conversation so far:\n`;
      conversationContext += `${message.from}: "${message.text}"\n`;
      
      for (const turn of message.conversation) {
        if (turn.role === 'user') {
          conversationContext += `Them: "${turn.text}"\n`;
        } else {
          conversationContext += `${message.from}: "${turn.text}"\n`;
        }
      }
      conversationContext += `Them: "${reply}"\n`;
      conversationContext += `\nNow respond as ${message.from}:`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 200,
          system: contactPersonalities[message.from] + `\n\nYou are having a natural, flowing text conversation. Remember what was said and build on it. React to what they actually said. Be funny and in character. Respond with ONLY your text message, nothing else.`,
          messages: [{ role: 'user', content: conversationContext }]
        })
      });

      const data = await response.json();
      const aiResponse = data.content?.[0]?.text || "sorry bad signal lol";

      // Update with AI response
      setMessages(prev => prev.map((m, i) => 
        i === messageIndex ? { 
          ...m, 
          conversation: [...newConversation, { role: 'contact', text: aiResponse }],
          loading: false 
        } : m
      ));
    } catch (error) {
      console.error('AI response error:', error);
      // Fallback response on error
      const fallbackResponses = {
        'Mom': 'Ok sweetie, get some sleep! üíï',
        'Dad': 'Alright, talk tomorrow. Love, Dad',
        'Best Friend': 'lmaooo ok anyway',
        'Hairy Larry': '...larry understands. larry always understands.',
        'Yumbus': 'YUMBUS WILL REMEMBER THIS MOMENT',
        'Group Chat': 'Jake: lmao\nSarah: omg\nMike: üíÄ'
      };
      
      setMessages(prev => prev.map((m, i) => 
        i === messageIndex ? { 
          ...m, 
          conversation: [...newConversation, { role: 'contact', text: fallbackResponses[message.from] || 'ok' }],
          loading: false 
        } : m
      ));
    }
  };

  const startGame = (character) => {
    setSelectedCharacter(character);
    setGameState('playing');
  };

  // Starry Night inspired start screen
  const StartScreen = () => {
    return (
      <div className="w-full h-screen overflow-hidden relative">
        {/* Swirly night sky background */}
        <div className="absolute inset-0 bg-gradient-to-b from-indigo-950 via-blue-900 to-indigo-900">
          {/* Swirl patterns */}
          <svg className="absolute inset-0 w-full h-full opacity-30" viewBox="0 0 800 600">
            {/* Large swirls */}
            <circle cx="150" cy="120" r="60" fill="none" stroke="#fbbf24" strokeWidth="8" className="animate-spin" style={{ transformOrigin: '150px 120px', animationDuration: '20s' }} />
            <circle cx="150" cy="120" r="45" fill="none" stroke="#fcd34d" strokeWidth="6" className="animate-spin" style={{ transformOrigin: '150px 120px', animationDuration: '15s' }} />
            <circle cx="150" cy="120" r="30" fill="none" stroke="#fde68a" strokeWidth="4" />
            
            <circle cx="650" cy="100" r="50" fill="none" stroke="#60a5fa" strokeWidth="6" className="animate-spin" style={{ transformOrigin: '650px 100px', animationDuration: '25s' }} />
            <circle cx="650" cy="100" r="35" fill="none" stroke="#93c5fd" strokeWidth="4" />
            
            <circle cx="400" cy="180" r="70" fill="none" stroke="#818cf8" strokeWidth="8" className="animate-spin" style={{ transformOrigin: '400px 180px', animationDuration: '30s' }} />
            <circle cx="400" cy="180" r="50" fill="none" stroke="#a5b4fc" strokeWidth="5" />
            
            {/* Wavy lines */}
            <path d="M0,250 Q100,220 200,250 T400,250 T600,250 T800,250" fill="none" stroke="#3b82f6" strokeWidth="4" opacity="0.5" />
            <path d="M0,280 Q100,310 200,280 T400,280 T600,280 T800,280" fill="none" stroke="#6366f1" strokeWidth="3" opacity="0.4" />
          </svg>
          
          {/* Stars */}
          {[...Array(80)].map((_, i) => (
            <div
              key={i}
              className="absolute rounded-full animate-pulse"
              style={{
                width: `${Math.random() * 4 + 2}px`,
                height: `${Math.random() * 4 + 2}px`,
                backgroundColor: ['#fbbf24', '#fde68a', '#fff', '#93c5fd', '#c4b5fd'][Math.floor(Math.random() * 5)],
                top: `${Math.random() * 60}%`,
                left: `${Math.random() * 100}%`,
                animationDelay: `${Math.random() * 3}s`,
                animationDuration: `${Math.random() * 2 + 1}s`,
                boxShadow: '0 0 6px currentColor',
              }}
            />
          ))}
          
          {/* Big moon */}
          <div className="absolute top-16 right-24 w-24 h-24 bg-gradient-to-br from-yellow-100 to-yellow-300 rounded-full shadow-lg" style={{ boxShadow: '0 0 60px 20px rgba(253, 224, 71, 0.4)' }}>
            <div className="absolute top-4 left-4 w-6 h-6 bg-yellow-200/50 rounded-full" />
            <div className="absolute top-10 right-6 w-4 h-4 bg-yellow-200/50 rounded-full" />
          </div>
          
          {/* Rolling hills silhouette */}
          <div className="absolute bottom-0 left-0 right-0 h-48">
            <svg className="w-full h-full" viewBox="0 0 800 200" preserveAspectRatio="none">
              <path d="M0,200 L0,120 Q100,80 200,100 Q300,130 400,90 Q500,50 600,80 Q700,110 800,70 L800,200 Z" fill="#1e1b4b" />
              <path d="M0,200 L0,150 Q150,120 300,140 Q450,160 600,130 Q750,100 800,120 L800,200 Z" fill="#312e81" />
            </svg>
          </div>
          
          {/* Cypress tree silhouette */}
          <div className="absolute bottom-32 left-20">
            <div className="w-8 h-40 bg-indigo-950 rounded-t-full" style={{ clipPath: 'polygon(50% 0%, 100% 100%, 0% 100%)' }} />
            <div className="w-10 h-48 bg-indigo-950 rounded-t-full -mt-32 -ml-1" style={{ clipPath: 'polygon(50% 0%, 85% 100%, 15% 100%)' }} />
          </div>
        </div>
        
        {/* Content */}
        <div className="relative z-10 flex flex-col items-center justify-center h-full">
          <h1 className="text-5xl font-bold text-yellow-100 mb-2" style={{ textShadow: '0 0 20px rgba(253, 224, 71, 0.5)' }}>
            Cozy Night In
          </h1>
          <p className="text-indigo-200 mb-12 text-lg">Choose your sleepy friend</p>
          
          {/* Character selection */}
          <div className="flex gap-8">
            {characters.map((char) => (
              <button
                key={char.id}
                onClick={() => startGame(char.id)}
                className="group flex flex-col items-center"
              >
                <div className="w-32 h-32 bg-indigo-800/50 backdrop-blur rounded-2xl border-2 border-indigo-400/30 flex items-center justify-center text-6xl mb-3 transition-all group-hover:scale-110 group-hover:border-yellow-400/50 group-hover:bg-indigo-700/50 group-hover:shadow-lg group-hover:shadow-yellow-400/20">
                  {char.emoji}
                </div>
                <span className="text-indigo-100 text-lg group-hover:text-yellow-200 transition-colors">{char.name}</span>
              </button>
            ))}
          </div>
          
          <p className="text-indigo-300/60 mt-16 text-sm">Click a character to begin your cozy evening</p>
        </div>
      </div>
    );
  };

  // Character components
  const GooseCharacter = () => (
    <div className="relative">
      {/* Neck */}
      <div className="absolute -top-16 left-1/2 -translate-x-1/2 w-8 h-20 bg-white rounded-full shadow-md" />
      {/* Head */}
      <div className="absolute -top-28 left-1/2 -translate-x-1/2 w-14 h-14 bg-white rounded-full shadow-md">
        {/* Beak */}
        <div className="absolute top-5 -right-4 w-8 h-4 bg-orange-400 rounded-r-full shadow-sm" />
        {/* Eye */}
        <div className="absolute top-4 left-6 w-3 h-3 bg-black rounded-full" />
      </div>
      {/* Body visible above blanket */}
      <div className="w-32 h-12 bg-white rounded-t-full shadow-md" />
    </div>
  );

  const HumanCharacter = () => (
    <div className="relative">
      {/* Head */}
      <div className="absolute -top-24 left-1/2 -translate-x-1/2 w-20 h-20 bg-amber-200 rounded-full shadow-md">
        {/* Hair */}
        <div className="absolute -top-1 left-1 right-1 h-10 bg-amber-800 rounded-t-full" />
        {/* Eyes - closed/sleepy */}
        <div className="absolute top-9 left-4 w-3 h-0.5 bg-gray-700 rounded" />
        <div className="absolute top-9 right-4 w-3 h-0.5 bg-gray-700 rounded" />
        {/* Mouth - slight smile */}
        <div className="absolute top-13 left-1/2 -translate-x-1/2 w-4 h-2 border-b-2 border-gray-600 rounded-b-full" style={{ top: '52px' }} />
      </div>
      {/* Neck */}
      <div className="absolute -top-6 left-1/2 -translate-x-1/2 w-8 h-8 bg-amber-200 rounded-b-lg" />
      {/* Shoulders visible above blanket */}
      <div className="w-36 h-8 bg-blue-400 rounded-t-lg shadow-md" />
    </div>
  );

  const PandaCharacter = () => (
    <div className="relative">
      {/* Head */}
      <div className="absolute -top-24 left-1/2 -translate-x-1/2 w-24 h-22 bg-white rounded-full shadow-md" style={{ height: '88px' }}>
        {/* Ears */}
        <div className="absolute -top-3 left-1 w-8 h-8 bg-black rounded-full" />
        <div className="absolute -top-3 right-1 w-8 h-8 bg-black rounded-full" />
        {/* Eye patches */}
        <div className="absolute top-5 left-3 w-7 h-6 bg-black rounded-full rotate-[-15deg]" />
        <div className="absolute top-5 right-3 w-7 h-6 bg-black rounded-full rotate-[15deg]" />
        {/* Eyes */}
        <div className="absolute top-7 left-5 w-2 h-2 bg-white rounded-full" />
        <div className="absolute top-7 right-5 w-2 h-2 bg-white rounded-full" />
        {/* Nose */}
        <div className="absolute top-12 left-1/2 -translate-x-1/2 w-4 h-3 bg-black rounded-full" />
        {/* Mouth */}
        <div className="absolute top-16 left-1/2 -translate-x-1/2 w-2 h-2 border-b-2 border-l-2 border-r-2 border-gray-800 rounded-b-full" />
      </div>
      {/* Body visible above blanket */}
      <div className="w-32 h-10 bg-white rounded-t-full shadow-md">
        {/* Black shoulders */}
        <div className="absolute top-2 left-0 w-8 h-6 bg-black rounded-tl-full" />
        <div className="absolute top-2 right-0 w-8 h-6 bg-black rounded-tr-full" />
      </div>
    </div>
  );

  const CharacterInBed = () => {
    switch (selectedCharacter) {
      case 'goose':
        return <GooseCharacter />;
      case 'human':
        return <HumanCharacter />;
      case 'panda':
        return <PandaCharacter />;
      default:
        return <GooseCharacter />;
    }
  };

  // Show start screen if not playing
  if (gameState === 'start') {
    return <StartScreen />;
  }

  return (
    <div className="w-full h-screen bg-gray-900 overflow-hidden relative select-none">
      {/* Room background */}
      <div className="absolute inset-0 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900">
        {/* Window with moonlight */}
        <div className="absolute top-8 right-8 w-32 h-48 bg-indigo-950 rounded border-4 border-slate-700">
          <div className="absolute top-4 right-4 w-8 h-8 bg-yellow-100 rounded-full opacity-80 blur-sm" />
          <div className="absolute inset-0 bg-gradient-to-b from-indigo-900/30 to-transparent" />
          <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-slate-700" />
          <div className="absolute top-0 bottom-0 left-1/2 w-0.5 bg-slate-700" />
        </div>
        {/* Stars outside */}
        {[...Array(20)].map((_, i) => (
          <div 
            key={i}
            className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
            style={{ 
              top: `${Math.random() * 30}%`, 
              right: `${Math.random() * 20 + 5}%`,
              animationDelay: `${Math.random() * 2}s`
            }}
          />
        ))}
      </div>

      {/* Bed */}
      <div className="absolute bottom-52 left-1/2 -translate-x-1/2 w-[550px] h-[280px]">
        {/* Headboard - behind everything */}
        <div className="absolute -top-20 left-8 right-8 h-24 bg-amber-800 rounded-t-xl border-4 border-amber-900">
          <div className="absolute top-3 left-1/2 -translate-x-1/2 w-3/4 h-14 bg-amber-700 rounded-lg" />
        </div>
        
        {/* Bed frame - left side */}
        <div className="absolute top-0 left-0 w-3 h-full bg-amber-800 rounded-l" />
        {/* Bed frame - right side */}
        <div className="absolute top-0 right-0 w-3 h-full bg-amber-800 rounded-r" />
        {/* Bed frame - bottom */}
        <div className="absolute bottom-0 left-0 right-0 h-8 bg-amber-800 rounded-b-lg" />
        {/* Bed legs */}
        <div className="absolute -bottom-4 left-2 w-5 h-6 bg-amber-900 rounded-b" />
        <div className="absolute -bottom-4 right-2 w-5 h-6 bg-amber-900 rounded-b" />
        
        {/* Mattress area */}
        <div className="absolute top-0 left-3 right-3 bottom-8 bg-slate-100 rounded">
          {/* Sheet */}
          <div className="absolute inset-1 bg-slate-50 rounded" />
        </div>
        
        {/* Pillow - on top of mattress */}
        <div className="absolute top-4 left-1/2 -translate-x-1/2 w-48 h-20 bg-white rounded-2xl shadow-md border border-slate-200" />
        
        {/* Character - on top of pillow, above blanket */}
        <div className="absolute top-20 left-1/2 -translate-x-1/2 z-30">
          <CharacterInBed />
        </div>
        
        {/* Blanket - covers bottom half, under character head */}
        <div className="absolute bottom-8 left-3 right-3 h-40 bg-gradient-to-t from-indigo-600 via-indigo-500 to-indigo-400 rounded-b z-20">
          {/* Blanket fold */}
          <div className="absolute top-0 left-0 right-0 h-4 bg-indigo-300 rounded-t" />
          {/* Blanket texture */}
          {[...Array(6)].map((_, i) => (
            <div key={i} className="absolute h-px bg-indigo-300/30 left-4 right-4" style={{ top: `${i * 15 + 20}%` }} />
          ))}
          {/* Body lump */}
          <div className="absolute top-6 left-1/2 -translate-x-1/2 w-44 h-24 bg-indigo-500 rounded-full opacity-40" />
        </div>
      </div>

      {/* Nightstand with water */}
      <div className="absolute bottom-20 left-16">
        <div className="w-20 h-24 bg-amber-800 rounded">
          {/* Lamp */}
          <div className="absolute -top-16 left-1/2 -translate-x-1/2">
            <div className="w-12 h-12 bg-yellow-100/80 rounded-full blur-sm" />
            <div className="absolute top-4 left-1/2 -translate-x-1/2 w-1 h-8 bg-amber-600" />
          </div>
          {/* Water glass */}
          <button 
            onClick={drinkWater}
            className="absolute -top-8 right-2 w-8 h-10 bg-blue-200/60 rounded border-2 border-blue-300/60 hover:scale-110 transition-transform cursor-pointer"
          >
            <div 
              className="absolute bottom-0 left-0 right-0 bg-blue-400/60 rounded-b transition-all"
              style={{ height: `${hydration}%` }}
            />
          </button>
        </div>
      </div>

      {/* Phone charging cable visual */}
      {isCharging && (
        <div className="absolute bottom-48 right-32 w-px h-20 bg-white/30" />
      )}

      {/* Phone Screen Overlay */}
      {phoneOpen && (
        <div className="absolute inset-0 flex items-center justify-center bg-black/50 z-20">
          <div className="w-72 h-[500px] bg-gray-900 rounded-3xl p-2 shadow-2xl border-4 border-gray-800">
            <div className="w-full h-full bg-gray-100 rounded-2xl overflow-hidden flex flex-col">
              {/* Status bar */}
              <div className="bg-gray-200 px-4 py-1 flex justify-between items-center text-xs text-gray-600">
                <span>{formatTime(time)}</span>
                <div className="flex items-center gap-2">
                  {isCharging && <span className="text-green-500">‚ö°</span>}
                  <span className={batteryLevel < 20 ? 'text-red-500' : ''}>{Math.round(batteryLevel)}%</span>
                </div>
              </div>

              {/* App content */}
              <div className="flex-1 overflow-hidden">
                {currentApp === null && (
                  <div className="h-full bg-gradient-to-b from-indigo-900 to-purple-900 p-4">
                    <button 
                      onClick={() => setPhoneOpen(false)}
                      className="absolute top-12 right-4 text-white/70 hover:text-white text-xl"
                    >
                      ‚úï
                    </button>
                    <div className="grid grid-cols-4 gap-3 mt-4">
                      <button onClick={() => setCurrentApp('social')} className="flex flex-col items-center">
                        <div className="w-12 h-12 bg-gradient-to-br from-pink-500 to-orange-400 rounded-xl flex items-center justify-center text-white text-xl relative">
                          üì±
                          {notifications > 0 && (
                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center">{notifications}</span>
                          )}
                        </div>
                        <span className="text-white text-xs mt-1">Social</span>
                      </button>
                      <button onClick={() => setCurrentApp('messages')} className="flex flex-col items-center">
                        <div className="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center text-white text-xl relative">
                          üí¨
                          {messages.filter(m => !m.read).length > 0 && (
                            <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center text-white">{messages.filter(m => !m.read).length}</span>
                          )}
                        </div>
                        <span className="text-white text-xs mt-1">Messages</span>
                      </button>
                      <button onClick={() => setCurrentApp('weather')} className="flex flex-col items-center">
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-cyan-500 rounded-xl flex items-center justify-center text-white text-xl">
                          üåô
                        </div>
                        <span className="text-white text-xs mt-1">Weather</span>
                      </button>
                      <button onClick={() => setCurrentApp('music')} className="flex flex-col items-center">
                        <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-green-700 rounded-xl flex items-center justify-center text-white text-xl">
                          üéµ
                        </div>
                        <span className="text-white text-xs mt-1">Music</span>
                      </button>
                    </div>
                  </div>
                )}

                {currentApp === 'social' && (
                  <div className="h-full bg-white flex flex-col">
                    <div className="bg-gradient-to-r from-pink-500 to-orange-400 p-3 flex justify-between items-center">
                      <button onClick={() => setCurrentApp(null)} className="text-white">‚Üê</button>
                      <span className="text-white font-bold">Feed</span>
                      <button onClick={refreshFeed} className="text-white text-sm">‚Üª</button>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                      {feed.map((post, i) => (
                        <div key={i} className="p-3 border-b border-gray-100">
                          <div className="flex items-center gap-2 mb-1">
                            <div className="w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full" />
                            <span className="font-medium text-sm">{post.user}</span>
                          </div>
                          <p className="text-sm text-gray-700">{post.content}</p>
                          <div className="flex gap-4 mt-2 text-xs text-gray-500">
                            <span>‚ù§Ô∏è {typeof post.likes === 'number' ? post.likes : `${post.likes}k`}</span>
                            <span>üí¨ {Math.floor(Math.random() * 50)}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {currentApp === 'messages' && (
                  <div className="h-full bg-white flex flex-col">
                    <div className="bg-green-500 p-3 flex items-center gap-3">
                      <button onClick={() => { setCurrentApp(null); setActiveMessageIndex(null); }} className="text-white">‚Üê</button>
                      <span className="text-white font-bold">Messages</span>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                      {activeMessageIndex !== null ? (
                        <div className="flex flex-col h-full">
                          <div className="p-3 border-b border-gray-200 bg-gray-50">
                            <button 
                              onClick={() => setActiveMessageIndex(null)}
                              className="text-green-500 text-sm mb-2"
                            >
                              ‚Üê Back to messages
                            </button>
                            <div className="font-medium">{messages[activeMessageIndex].from}</div>
                          </div>
                          <div className="flex-1 p-3 space-y-3 overflow-y-auto">
                            <div className="flex justify-start">
                              <div className="bg-gray-200 rounded-2xl rounded-tl-sm px-3 py-2 max-w-[80%]">
                                <p className="text-sm whitespace-pre-wrap">{messages[activeMessageIndex].text}</p>
                                <p className="text-xs text-gray-500 mt-1">{messages[activeMessageIndex].time}</p>
                              </div>
                            </div>
                            
                            {messages[activeMessageIndex].conversation.map((turn, i) => (
                              <div key={i} className={`flex ${turn.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`rounded-2xl px-3 py-2 max-w-[80%] ${
                                  turn.role === 'user' 
                                    ? 'bg-green-500 text-white rounded-tr-sm' 
                                    : 'bg-gray-200 rounded-tl-sm'
                                }`}>
                                  <p className="text-sm whitespace-pre-wrap">{turn.text}</p>
                                </div>
                              </div>
                            ))}
                            
                            {messages[activeMessageIndex].loading && (
                              <div className="flex justify-start">
                                <div className="bg-gray-200 rounded-2xl rounded-tl-sm px-4 py-3">
                                  <div className="flex gap-1">
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                          
                          {!messages[activeMessageIndex].loading && (
                            <div className="p-2 border-t border-gray-200 bg-gray-50">
                              <div className="flex gap-2">
                                <input
                                  type="text"
                                  value={replyText}
                                  onChange={(e) => setReplyText(e.target.value)}
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter' && replyText.trim()) {
                                      const idx = activeMessageIndex;
                                      const text = replyText.trim();
                                      setReplyText('');
                                      sendReply(idx, text);
                                    }
                                  }}
                                  placeholder="Type a message..."
                                  className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-full focus:outline-none focus:border-green-500 bg-white"
                                  autoComplete="off"
                                  autoCorrect="off"
                                  autoCapitalize="off"
                                  spellCheck="false"
                                />
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (replyText.trim()) {
                                      const idx = activeMessageIndex;
                                      const text = replyText.trim();
                                      setReplyText('');
                                      sendReply(idx, text);
                                    }
                                  }}
                                  className={`px-4 py-2 rounded-full transition text-sm text-white ${replyText.trim() ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300'}`}
                                >
                                  Send
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      ) : (
                        messages.map((msg, i) => (
                          <button 
                            key={i} 
                            onClick={() => readMessage(i)}
                            className={`w-full p-3 border-b border-gray-100 text-left ${!msg.read ? 'bg-green-50' : ''}`}
                          >
                            <div className="flex justify-between items-center">
                              <span className={`font-medium ${!msg.read ? 'text-black' : 'text-gray-600'}`}>{msg.from}</span>
                              <span className="text-xs text-gray-400">{msg.time}</span>
                            </div>
                            <p className={`text-sm truncate ${!msg.read ? 'text-gray-700' : 'text-gray-400'}`}>
                              {msg.conversation.length > 0 
                                ? msg.conversation[msg.conversation.length - 1].text 
                                : msg.text}
                            </p>
                            {msg.conversation.length > 0 && (
                              <p className="text-xs text-green-500 mt-1">
                                {msg.conversation.length} message{msg.conversation.length !== 1 ? 's' : ''} in conversation
                              </p>
                            )}
                          </button>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {currentApp === 'weather' && (
                  <div className="h-full bg-gradient-to-b from-indigo-900 to-blue-900 flex flex-col items-center justify-center text-white p-4">
                    <button onClick={() => setCurrentApp(null)} className="absolute top-12 left-4 text-white">‚Üê</button>
                    <div className="text-6xl mb-4">üåô</div>
                    <div className="text-5xl font-light mb-2">62¬∞</div>
                    <div className="text-lg opacity-80">Clear Night</div>
                    <div className="mt-8 text-sm opacity-60">Perfect weather for staying in bed</div>
                  </div>
                )}

                {currentApp === 'music' && (
                  <div className="h-full bg-gradient-to-b from-gray-900 to-gray-800 flex flex-col items-center justify-center text-white p-4">
                    <button onClick={() => setCurrentApp(null)} className="absolute top-12 left-4 text-white">‚Üê</button>
                    <div className="w-40 h-40 bg-gradient-to-br from-purple-600 to-pink-500 rounded-lg mb-6 flex items-center justify-center text-6xl">
                      üéß
                    </div>
                    <div className="text-lg font-medium">lofi beats to chill to</div>
                    <div className="text-sm opacity-60 mb-6">Cozy Vibes Radio</div>
                    <div className="flex items-center gap-8 text-2xl">
                      <button className="opacity-60 hover:opacity-100">‚èÆ</button>
                      <button className="w-12 h-12 bg-white text-gray-900 rounded-full flex items-center justify-center">‚ñ∂</button>
                      <button className="opacity-60 hover:opacity-100">‚è≠</button>
                    </div>
                  </div>
                )}
              </div>

              {/* Home indicator */}
              <div className="bg-gray-200 py-2 flex justify-center">
                <button 
                  onClick={() => {
                    if (currentApp) {
                      setCurrentApp(null);
                      setActiveMessageIndex(null);
                    } else {
                      setPhoneOpen(false);
                    }
                  }}
                  className="w-24 h-1 bg-gray-400 rounded-full hover:bg-gray-500 transition"
                />
              </div>
            </div>
          </div>
        </div>
      )}

      {/* UI Overlay */}
      <div className="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
        {/* Stats */}
        <div className="bg-gray-800/80 rounded-lg p-3 space-y-2 backdrop-blur">
          <div className="text-white text-lg font-medium">{formatTime(time)}</div>
          <div className="flex items-center gap-2">
            <span className="text-blue-400">üíß</span>
            <div className="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div 
                className={`h-full transition-all ${hydration < 30 ? 'bg-red-500' : 'bg-blue-400'}`}
                style={{ width: `${hydration}%` }}
              />
            </div>
            <span className="text-white text-xs">{Math.round(hydration)}%</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-yellow-400">üòä</span>
            <div className="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div 
                className="h-full bg-yellow-400 transition-all"
                style={{ width: `${comfort}%` }}
              />
            </div>
            <span className="text-white text-xs">{Math.round(comfort)}%</span>
          </div>
          <div className="text-gray-400 text-xs">Position: {position}</div>
        </div>

        {/* Controls hint */}
        <div className="bg-gray-800/80 rounded-lg p-3 text-white text-sm backdrop-blur">
          <div className="font-medium mb-2">Actions</div>
          <div className="space-y-1 text-gray-300 text-xs">
            <div>‚Ä¢ Click water glass to drink</div>
            <div>‚Ä¢ Click bed to use phone</div>
            <div>‚Ä¢ Click buttons to interact</div>
          </div>
        </div>
      </div>

      {/* Bottom action buttons */}
      <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-3 z-10">
        <button 
          onClick={() => setPhoneOpen(true)}
          className="bg-gray-800/90 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur transition"
        >
          üì± Check Phone
          {notifications > 0 && (
            <span className="bg-red-500 text-xs px-1.5 py-0.5 rounded-full">{notifications}</span>
          )}
        </button>
        <button 
          onClick={drinkWater}
          className="bg-blue-600/90 hover:bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur transition"
        >
          üíß Drink Water
        </button>
        <button 
          onClick={changePosition}
          className="bg-purple-600/90 hover:bg-purple-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur transition"
        >
          üîÑ Change Position
        </button>
        <button 
          onClick={() => setIsCharging(!isCharging)}
          className={`${isCharging ? 'bg-green-600/90 hover:bg-green-500' : 'bg-gray-800/90 hover:bg-gray-700'} text-white px-4 py-2 rounded-lg flex items-center gap-2 backdrop-blur transition`}
        >
          üîå {isCharging ? 'Unplug' : 'Charge Phone'}
        </button>
      </div>

      {/* Low hydration warning */}
      {hydration < 30 && (
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500/90 text-white px-6 py-3 rounded-lg animate-pulse z-30">
          üíß Getting thirsty... drink some water!
        </div>
      )}
    </div>
  );
}
